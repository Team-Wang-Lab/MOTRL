---
title: "SARA_Data_example"
author: "Yao Song"
date: "6/20/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readxl)
library(ggpubr)
library(ggplot2)
# library(TRL)
library(randomForest)
library(boot) 
library(table1)
library(dplyr)
library(rpart)
library(sjPlot)
library(sjmisc)
library(sjlabelled)
library(missForest)
library(PerformanceAnalytics)
```



# 1. Import Data

```{r}
# SARAData = read_excel("SARA T_RL MHQ 032222.xlsx", na = c("","-", "NA"))
SARAData = read_excel("SARA T_RL Clean 012022.xlsx", na = c("","-", "NA")) # original data
variables = c("AGE", "GENDER", "CHARLSON", "DMARDs", "Steroids", "MHQ_pain_enrollment", "SUM_MPEXTLAG_enrollment","SUM_MPUD_enrollment", "GRIP_AVG", "AIMS2_enrollment", 
              "SMPA_FING2_5",
              "MHQ_pain_y1", 
              "dSUM_MPEXTLAG_y1",
              "dSUM_MPUD_y1", 
              "AIMS2_y1")
VarNames = c("AGE", "GENDER", "CHARLSON", "DMARDs", "Steroids", "MHQ_pain_enrollment", "SUM_MPEXTLAG_enrollment","SUM_MPUD_enrollment", "GRIP_AVG", "AIMS2_enrollment", "SMPA_FING2_5",
              "MHQ_pain", "dSUM_MPEXTLAG", "dSUM_MPUD", "AIMS2")

Y1Data = SARAData[, variables]
colnames(Y1Data) = VarNames
Y1Data$MHQ_pain = -1*as.numeric(Y1Data$MHQ_pain)
Y1Data$AGE = as.numeric(Y1Data$AGE) 
Y1Data$MHQ_pain_enrollment = -1*as.numeric(Y1Data$MHQ_pain_enrollment)


Y1Data$GENDER = as.factor(Y1Data$GENDER) 
Y1Data$CHARLSON = as.factor(Y1Data$CHARLSON)
Y1Data$DMARDs = as.factor(Y1Data$DMARDs)
Y1Data$Steroids = as.factor(Y1Data$Steroids)
Y1Data$SMPA_FING2_5 = as.factor(Y1Data$SMPA_FING2_5)
levels(Y1Data$GENDER) <- c("Female", "Male")
levels(Y1Data$Steroids) = levels(Y1Data$DMARDs) <- c("No", "Yes")
levels(Y1Data$SMPA_FING2_5) <- c("No SMPA", "SMPA")
```

# 2. Generating complete cohort (132/149 observations)

```{r}
CompY1.table = Y1Data[complete.cases(Y1Data), ] # Using this as data for table
```


## MODELS for complete cohort

1 Stage (baseline ~ Year 1) 2 Treatment (SMPA_FING2_5 or not)

lambda.pct = minimum purity improvement as a percent of the estimated counterfactual mean at root node without splitting 
minsplit = minimum node size
pis.hat = propensity

# Preparing data for models

```{r}
# Getting CompY1 for models
CompY1 <- Y1Data[complete.cases(Y1Data), ]
CompY1$CHARLSON<-as.numeric(CompY1$CHARLSON)
CompY1$GENDER<-ifelse(CompY1$GENDER=="Female",1,0)
CompY1$DMARDs<-ifelse(CompY1$DMARDs=="Yes",1,0)
CompY1$Steroids<-ifelse(CompY1$Steroids=="Yes",1,0)
CompY1$SMPA_FING2_5<-ifelse(CompY1$SMPA_FING2_5=="SMPA",1,0) ###
CompY1$AIMS2 = -1*CompY1$AIMS2
CompY1$dSUM_MPEXTLAG = -1*CompY1$dSUM_MPEXTLAG

# prepare for models
N = dim(CompY1)[1]
SMPA = CompY1$SMPA_FING2_5 + 1
Cov = as.matrix(CompY1[,c(1:10)])
class.SMPA = sort(unique(SMPA))
```

```{r}
################################################
#################1. MHQ_pain ###################
# 1.1 Conditional mean model using linear regression 
R1_MHQ_pain = CompY1$MHQ_pain
REG1_MHQ_pain <- Reg.mu(Y = R1_MHQ_pain, As = SMPA, H = Cov)
mus2.reg1_MHQ_pain <- REG1_MHQ_pain$mus.reg
# Give Output
lm1 = lm(R1_MHQ_pain ~ Cov * SMPA, data = CompY1)
tab_model(lm1, 
          pred.labels = c("(Intercept)", "Age", "Gender", "Charlson",
                  "DMARDs", "Steriods", "MHQ_pain_enrollment", 
                  "SUM_MPEXTLAG_enrollment", "SUM_MPUD_enrollment", 
                  "GRIP_AVG", "AIMS2_enrollment", "SMPA", "Age:SMPA", "Gender:SMPA", 
                  "Charlson:SMPA", "DMARDs:SMPA", "Steriods:SMPA", 
                  "MHQ_pain_enrollment:SMPA","SUM_MPEXTLAG_enrollment:SMPA", "SUM_MPUD_enrollment:SMPA", 
                  "GRIP_AVG:SMPA", "AIMS2_enrollment:SMPA"),
  dv.labels = c("MHQ_pain"),
  string.pred = "Coeffcient",
  string.ci = "Conf. Int (95%)",
  string.p = "P-Value")

# 1.2 DTR tree      
tree1_MHQ_pain <- DTRtree(Y = R1_MHQ_pain, A = SMPA, H = Cov, mus.reg = mus2.reg1_MHQ_pain, lambda.pct= 0.02, depth = 3, minsplit = max(0.05 * N, 16))
knitr::kable(tree1_MHQ_pain, digits = 2)

# 1.3 Tolerant DTR tree
tree1_MHQ_pain.tol = tol.DTRtree(Y = R1_MHQ_pain, A = SMPA, H = Cov, tol.rate = 0, mus.reg = mus2.reg1_MHQ_pain, lambda.pct= 0.02, depth = 5, minsplit = max(0.05 * N, 16))
knitr::kable(tree1_MHQ_pain.tol, digits = 2)

# 1.4 Multi-objective Tolerant DTR tree
# Design a n*3 matrix to indicate 3 objectives
O1 = R1_MHQ_pain
O2 = log((exp(R1_MHQ_pain) + 1024)/345)
O3 = -log(abs(2^(R1_MHQ_pain +3)))
Outcomes = matrix(c(O1, O2, O3), ncol = 3)
# Design a pre-specified 3-dim weight vector w
weights = c(0.1, 0.3, 0.6)

# The most flexible case delta = 0 (allow all treatments)
tree1_MHQ_pain.MOtol0 = MO.tol.DTRtree(Ys = Outcomes, w = weights, A = SMPA, H = Cov, delta = 1, tolerate = TRUE, m.method="AIPW", depth=5, lambda.pct=0.02, minsplit = max(0.05 * N, 16))
knitr::kable(tree1_MHQ_pain.MOtol0, digits = 2)

# The most strict case delta = 1 (allow only the optimal treatment)
tree1_MHQ_pain.MOtol1 = MO.tol.DTRtree(Ys = Outcomes, w = weights, A = SMPA, H = Cov, delta = 0, tolerate = TRUE, m.method="AIPW", depth=5, lambda.pct=0.02, minsplit = max(0.05 * N, 16))
knitr::kable(tree1_MHQ_pain.MOtol1, digits = 2)
```

```{r}
################################################
############### 2. dSUM_MPEXTLAG ###############
# 2.1 Conditional mean model using linear regression 
R1_dSUM_MPEXTLAG = CompY1$dSUM_MPEXTLAG
REG1_dSUM_MPEXTLAG <- Reg.mu(Y = R1_dSUM_MPEXTLAG, As = SMPA, H = Cov)
mus2.reg1_dSUM_MPEXTLAG <- REG1_dSUM_MPEXTLAG$mus.reg
# Give Output
lm2 = lm(R1_dSUM_MPEXTLAG ~ Cov * SMPA, data = CompY1)
tab_model(lm2, 
          pred.labels = c("(Intercept)", "Age", "Gender", "Charlson",
                  "DMARDs", "Steriods", "MHQ_pain_enrollment", 
                  "SUM_MPEXTLAG_enrollment", "SUM_MPUD_enrollment", 
                  "GRIP_AVG", "AIMS2_enrollment", "SMPA", "Age:SMPA", "Gender:SMPA", 
                  "Charlson:SMPA", "DMARDs:SMPA", "Steriods:SMPA", 
                  "MHQ_pain_enrollment:SMPA","SUM_MPEXTLAG_enrollment:SMPA", "SUM_MPUD_enrollment:SMPA", 
                  "GRIP_AVG:SMPA", "AIMS2_enrollment:SMPA"),
  dv.labels = c("dSUM_MPEXTLAG"),
  string.pred = "Coeffcient",
  string.ci = "Conf. Int (95%)",
  string.p = "P-Value")

# 2.2 DTRtree     
tree1_dSUM_MPEXTLAG <- DTRtree(Y = R1_dSUM_MPEXTLAG, A = SMPA, H = Cov, mus.reg = mus2.reg1_dSUM_MPEXTLAG, lambda.pct= 0.02, depth = 3, minsplit = max(0.05 * N, 16))
knitr::kable(t(as.matrix(tree1_dSUM_MPEXTLAG)), digits = 2)


# Test for tolerant tree
tol.DTRtree(Y = R1_dSUM_MPEXTLAG, A = SMPA, H = Cov, tol.rate = 0, mus.reg = mus2.reg1_dSUM_MPEXTLAG, lambda.pct= 0.02, depth = 3, minsplit = max(0.05 * N, 16))
```


```{r}
################################################
################ 3. dSUM_MPUD ##################
# 3.1 conditional mean model using linear regression 
R1_dSUM_MPUD = CompY1$dSUM_MPUD
REG1_dSUM_MPUD <- Reg.mu(Y = R1_dSUM_MPUD, As = SMPA, H = Cov)
mus2.reg1_dSUM_MPUD <- REG1_dSUM_MPUD$mus.reg
# Give Output
lm3 = lm(R1_dSUM_MPUD ~ Cov * SMPA, data = CompY1)
tab_model(lm3, 
          pred.labels = c("(Intercept)", "Age", "Gender", "Charlson",
                  "DMARDs", "Steriods", "MHQ_pain_enrollment", 
                  "SUM_MPEXTLAG_enrollment", "SUM_MPUD_enrollment", 
                  "GRIP_AVG", "AIMS2_enrollment", "SMPA", "Age:SMPA", "Gender:SMPA", 
                  "Charlson:SMPA", "DMARDs:SMPA", "Steriods:SMPA", 
                  "MHQ_pain_enrollment:SMPA","SUM_MPEXTLAG_enrollment:SMPA", "SUM_MPUD_enrollment:SMPA", 
                  "GRIP_AVG:SMPA", "AIMS2_enrollment:SMPA"),
  dv.labels = c("dSUM_MPUD"),
  string.pred = "Coeffcient",
  string.ci = "Conf. Int (95%)",
  string.p = "P-Value")

# 3.2 DTRtree   
tree1_dSUM_MPUD <- DTRtree(Y = R1_dSUM_MPUD, A = SMPA, H = Cov, mus.reg = mus2.reg1_dSUM_MPUD, lambda.pct= 0.02, depth = 3, minsplit = max(0.05 * N, 16))
knitr::kable(t(as.matrix(tree1_dSUM_MPUD)), digits = 2)


# Test for tolerant tree
tol.DTRtree(Y = R1_dSUM_MPUD, A = SMPA, H = Cov, tol.rate = 0,mus.reg = mus2.reg1_dSUM_MPUD, lambda.pct= 0.02, depth = 3, minsplit = max(0.05 * N, 16))
```


```{r}
################################################
################## 4. AIMS2 ####################
# 4.1conditional mean model using linear regression 
R1_AIMS2 = CompY1$AIMS2
REG1_AIMS2 <- Reg.mu(Y = R1_AIMS2, As = SMPA, H = Cov)
mus2.reg1_AIMS2 <- REG1_AIMS2$mus.reg
# Give Output
lm4 = lm(R1_AIMS2 ~ Cov * SMPA, data = CompY1)
tab_model(lm4, 
          pred.labels = c("(Intercept)", "Age", "Gender", "Charlson",
                  "DMARDs", "Steriods", "MHQ_pain_enrollment", 
                  "SUM_MPEXTLAG_enrollment", "SUM_MPUD_enrollment", 
                  "GRIP_AVG", "AIMS2_enrollment", "SMPA", "Age:SMPA", "Gender:SMPA", 
                  "Charlson:SMPA", "DMARDs:SMPA", "Steriods:SMPA", 
                  "MHQ_pain_enrollment:SMPA","SUM_MPEXTLAG_enrollment:SMPA", "SUM_MPUD_enrollment:SMPA", 
                  "GRIP_AVG:SMPA", "AIMS2_enrollment:SMPA"),
  dv.labels = c("AIMS2"),
  string.pred = "Coeffcient",
  string.ci = "Conf. Int (95%)",
  string.p = "P-Value")

# 4.2 DTRtree    
tree1_AIMS2 <- DTRtree(Y = R1_AIMS2, A = SMPA, H = Cov, mus.reg = mus2.reg1_AIMS2, lambda.pct= 0.02, depth = 3, minsplit = max(0.05 * N, 16))
knitr::kable(tree1_AIMS2, digits = 2)

# Test for tolerant tree
tol.DTRtree(Y = R1_AIMS2, A = SMPA, H = Cov,tol.rate = 0, mus.reg = mus2.reg1_AIMS2, lambda.pct= 0.02, depth = 3, minsplit = max(0.05 * N, 16))

```



June 21 Test on 4 objectives

```{r}
# 1.4 Multi-objective Tolerant DTR tree
# 4 objectives
O1 = R1_MHQ_pain
O2 = R1_dSUM_MPEXTLAG
O3 = R1_dSUM_MPUD
O4 = R1_AIMS2
Outcomes = matrix(c(O1, O2, O3, O4), ncol = 4)
# Design a pre-specified 4-dim weight vector w
weights = c(0.4, 0.05, 0.05, 0.5)

# The most flexible case delta = 0 (allow all treatments)
tree_All.MOtol0 = MO.tol.DTRtree(Ys = Outcomes, w = weights, A = SMPA, H = Cov, delta = 1, tolerate = TRUE, m.method="AIPW", depth=5, lambda.pct=0.001, minsplit = 10)
knitr::kable(tree_All.MOtol0, digits = 2)

# The most strict case delta = 1 (allow only the optimal treatment)
tree_All.MOtol1 = MO.tol.DTRtree(Ys = Outcomes, w = weights, A = SMPA, H = Cov, delta = 0, tolerate = TRUE, m.method="AIPW", depth=5, lambda.pct=0.001, minsplit = 10)
knitr::kable(tree_All.MOtol1, digits = 2)

```







# 3. Generating full cohort (all 149 observations)


```{r}
Y1.table.full = Y1Data
Y1.table.full$GENDER = ifelse(Y1.table.full$GENDER == "Female", 1, 0)
Y1.table.full$DMARDs = ifelse(Y1.table.full$DMARDs == "Yes", 1, 0)
Y1.table.full$Steroids = ifelse(Y1.table.full$Steroids == "Yes", 1, 0)
Y1.table.full$SMPA_FING2_5 = ifelse(Y1.table.full$SMPA_FING2_5 == "SMPA", 1, 0)


FullY1.1 = missForest(data.matrix(Y1.table.full), maxiter = 10, ntree = 100)
## The final results can be accessed directly. The estimated error:
FullY1.1$OOBerror
## The imputed full cohort data
FullY1 = as.data.frame(FullY1.1$ximp)

# Table for full cohort
FullY1.table = FullY1
FullY1.table$GENDER = ifelse(FullY1.table$GENDER == 1, "Female", "Male")
FullY1.table$DMARDs = ifelse(FullY1.table$DMARDs == 1, "Yes", "No")
FullY1.table$Steroids = ifelse(FullY1.table$Steroids == 1, "Yes", "No")
FullY1.table$SMPA_FING2_5 = ifelse(FullY1.table$SMPA_FING2_5 == 1, "SMPA_FING2_5", "No SMPA_FING2_5")
FullY1.table$CHARLSON = factor(FullY1.table$CHARLSON) 
FullY1.table$SMPA_FING2_5 = factor(FullY1.table$SMPA_FING2_5) 
FullY1.table$GENDER = factor(FullY1.table$GENDER) 
levels(FullY1.table$SMPA_FING2_5) <- c("No SMPA", "SMPA")
```

*Table for full cohort*

```{r}
label(FullY1.table$GENDER)                  <- "Gender"
label(FullY1.table$AGE)                     <- "Age"
label(FullY1.table$CHARLSON)                <- "Charlson" # Need meaning of variable
label(FullY1.table$DMARDs)                  <- "DMARDs" # Need meaning of variable
label(FullY1.table$Steroids)                <- "Steroids" # Need meaning of variable
label(FullY1.table$MHQ_pain_enrollment)     <- "MHQ_pain_enrollment" # Need meaning of variable
label(FullY1.table$SUM_MPEXTLAG_enrollment) <- "SUM_MPEXTLAG_enrollment" # Need meaning of variable
label(FullY1.table$SUM_MPUD_enrollment)     <- "SUM_MPUD_enrollment" # Need meaning of variable
label(FullY1.table$GRIP_AVG)                <- "GRIP_AVG" # Need meaning of variable
label(FullY1.table$AIMS2_enrollment)        <- "AIMS2_enrollment" # Need meaning of variable
label(FullY1.table$MHQ_pain)                <- "MHQ_pain" # Need meaning of variable
label(FullY1.table$dSUM_MPEXTLAG)           <- "dSUM_MPEXTLAG" # Need meaning of variable
label(FullY1.table$dSUM_MPUD)               <- "dSUM_MPUD" # Need meaning of variable
label(FullY1.table$AIMS2)                   <- "AIMS2" # Need meaning of variable

strata = c(split(FullY1.table, FullY1.table$SMPA_FING2_5), list(Total = FullY1.table))
labels <- list(
    variables=list(AGE="Age (years)" ,
                   GENDER="Gender",
                   CHARLSON=render.varlabel(FullY1.table$CHARLSON),
                   DMARDs=render.varlabel(FullY1.table$DMARDs),
                   Steroids=render.varlabel(FullY1.table$Steroids),
                   MHQ_pain_enrollment=render.varlabel(FullY1.table$MHQ_pain_enrollment),
                   SUM_MPEXTLAG_enrollment=render.varlabel(FullY1.table$SUM_MPEXTLAG_enrollment),
                   SUM_MPUD_enrollment=render.varlabel(FullY1.table$SUM_MPUD_enrollment),
                   GRIP_AVG=render.varlabel(FullY1.table$GRIP_AVG),
                   AIMS2_enrollment=render.varlabel(FullY1.table$AIMS2_enrollment),
                   MHQ_pain=render.varlabel(FullY1.table$MHQ_pain),
                   dSUM_MPEXTLAG=render.varlabel(FullY1.table$dSUM_MPEXTLAG),
                   dSUM_MPUD=render.varlabel(FullY1.table$dSUM_MPUD),
                   AIMS2=render.varlabel(FullY1.table$AIMS2)),
    groups=list("Full Cohort"))

table1(strata, labels, groupspan = c(3)
       , render.continuous = my.render.cont, render.categorical = my.render.cat)
```

## MODELS for full cohort

```{r}
FullY1$AIMS2 = -1*FullY1$AIMS2
FullY1$dSUM_MPEXTLAG = -1*FullY1$dSUM_MPEXTLAG
N = dim(FullY1)[1]
SMPA = FullY1$SMPA_FING2_5
Cov = as.matrix(FullY1[,c(1:10)])
class.SMPA = sort(unique(SMPA))
```

```{r}
################################################
#################1. MHQ_pain ###################
# 1.1 Conditional mean model using linear regression 
R1_MHQ_pain.f = FullY1$MHQ_pain
REG1_MHQ_pain.f <- Reg.mu(Y = R1_MHQ_pain.f, As = SMPA, H = Cov)
mus2.reg1_MHQ_pain.f <- REG1_MHQ_pain.f$mus.reg
# Give Output
lm1.f = lm(R1_MHQ_pain.f ~ Cov * SMPA, data = FullY1)
tab_model(lm1.f, 
          pred.labels = c("(Intercept)", "Age", "Gender", "Charlson",
                  "DMARDs", "Steriods", "MHQ_pain_enrollment", 
                  "SUM_MPEXTLAG_enrollment", "SUM_MPUD_enrollment", 
                  "GRIP_AVG", "AIMS2_enrollment", "SMPA", "Age:SMPA", "Gender:SMPA", 
                  "Charlson:SMPA", "DMARDs:SMPA", "Steriods:SMPA", 
                  "MHQ_pain_enrollment:SMPA","SUM_MPEXTLAG_enrollment:SMPA", "SUM_MPUD_enrollment:SMPA", 
                  "GRIP_AVG:SMPA", "AIMS2_enrollment:SMPA"),
  dv.labels = c("MHQ_pain"),
  string.pred = "Coeffcient",
  string.ci = "Conf. Int (95%)",
  string.p = "P-Value")

# 1.2 DTRtree      
tree1_MHQ_pain.f <- DTRtree(Y = R1_MHQ_pain.f, A = SMPA, H = Cov, mus.reg = mus2.reg1_MHQ_pain.f, lambda.pct= 0.02, depth = 3, minsplit = max(0.05 * N, 16))
knitr::kable(tree1_MHQ_pain.f, digits = 2)
```


```{r}
################################################
############### 2. dSUM_MPEXTLAG ###############
# 2.1 Conditional mean model using linear regression 
R1_dSUM_MPEXTLAG.f = FullY1$dSUM_MPEXTLAG
REG1_dSUM_MPEXTLAG.f <- Reg.mu(Y = R1_dSUM_MPEXTLAG.f, As = SMPA, H = Cov)
mus2.reg1_dSUM_MPEXTLAG.f <- REG1_dSUM_MPEXTLAG.f$mus.reg
# Give Output
lm2.f = lm(R1_dSUM_MPEXTLAG.f ~ Cov * SMPA, data = FullY1)
tab_model(lm2.f, 
          pred.labels = c("(Intercept)", "Age", "Gender", "Charlson",
                  "DMARDs", "Steriods", "MHQ_pain_enrollment", 
                  "SUM_MPEXTLAG_enrollment", "SUM_MPUD_enrollment", 
                  "GRIP_AVG", "AIMS2_enrollment", "SMPA", "Age:SMPA", "Gender:SMPA", 
                  "Charlson:SMPA", "DMARDs:SMPA", "Steriods:SMPA", 
                  "MHQ_pain_enrollment:SMPA","SUM_MPEXTLAG_enrollment:SMPA", "SUM_MPUD_enrollment:SMPA", 
                  "GRIP_AVG:SMPA", "AIMS2_enrollment:SMPA"),
  dv.labels = c("dSUM_MPEXTLAG"),
  string.pred = "Coeffcient",
  string.ci = "Conf. Int (95%)",
  string.p = "P-Value")

# 2.2 DTRtree     
tree1_dSUM_MPEXTLAG.f <- DTRtree(Y = R1_dSUM_MPEXTLAG.f, A = SMPA, H = Cov, mus.reg = mus2.reg1_dSUM_MPEXTLAG.f, lambda.pct= 0.02, depth = 3, minsplit = max(0.05 * N, 16))
knitr::kable(t(as.matrix(tree1_dSUM_MPEXTLAG.f)), digits = 2)

```

```{r}
################################################
################ 3. dSUM_MPUD ##################
# 3.1 conditional mean model using linear regression 
R1_dSUM_MPUD.f = FullY1$dSUM_MPUD
REG1_dSUM_MPUD.f <- Reg.mu(Y = R1_dSUM_MPUD.f, As = SMPA, H = Cov)
mus2.reg1_dSUM_MPUD.f <- REG1_dSUM_MPUD.f$mus.reg
# Give Output
lm3.f = lm(R1_dSUM_MPUD.f ~ Cov * SMPA, data = FullY1)
tab_model(lm3.f, 
          pred.labels = c("(Intercept)", "Age", "Gender", "Charlson",
                  "DMARDs", "Steriods", "MHQ_pain_enrollment", 
                  "SUM_MPEXTLAG_enrollment", "SUM_MPUD_enrollment", 
                  "GRIP_AVG", "AIMS2_enrollment", "SMPA", "Age:SMPA", "Gender:SMPA", 
                  "Charlson:SMPA", "DMARDs:SMPA", "Steriods:SMPA", 
                  "MHQ_pain_enrollment:SMPA","SUM_MPEXTLAG_enrollment:SMPA", "SUM_MPUD_enrollment:SMPA", 
                  "GRIP_AVG:SMPA", "AIMS2_enrollment:SMPA"),
  dv.labels = c("dSUM_MPUD"),
  string.pred = "Coeffcient",
  string.ci = "Conf. Int (95%)",
  string.p = "P-Value")

# 3.2 DTRtree   
tree1_dSUM_MPUD.f <- DTRtree(Y = R1_dSUM_MPUD.f, A = SMPA, H = Cov, mus.reg = mus2.reg1_dSUM_MPUD.f, lambda.pct= 0.02, depth = 3, minsplit = max(0.05 * N, 16))
knitr::kable(t(as.matrix(tree1_dSUM_MPUD.f)), digits = 2)
```

```{r}
################################################
################## 4. AIMS2 ####################
# 4.1conditional mean model using linear regression 
R1_AIMS2.f = FullY1$AIMS2
REG1_AIMS2.f <- Reg.mu(Y = R1_AIMS2.f, As = SMPA, H = Cov)
mus2.reg1_AIMS2.f <- REG1_AIMS2.f$mus.reg
# Give Output
lm4.f = lm(R1_AIMS2.f ~ Cov * SMPA, data = FullY1)
tab_model(lm4.f, 
          pred.labels = c("(Intercept)", "Age", "Gender", "Charlson",
                  "DMARDs", "Steriods", "MHQ_pain_enrollment", 
                  "SUM_MPEXTLAG_enrollment", "SUM_MPUD_enrollment", 
                  "GRIP_AVG", "AIMS2_enrollment", "SMPA", "Age:SMPA", "Gender:SMPA", 
                  "Charlson:SMPA", "DMARDs:SMPA", "Steriods:SMPA", 
                  "MHQ_pain_enrollment:SMPA","SUM_MPEXTLAG_enrollment:SMPA", "SUM_MPUD_enrollment:SMPA", 
                  "GRIP_AVG:SMPA", "AIMS2_enrollment:SMPA"),
  dv.labels = c("AIMS2"),
  string.pred = "Coeffcient",
  string.ci = "Conf. Int (95%)",
  string.p = "P-Value")

# 4.2 DTRtree    
tree1_AIMS2.f <- DTRtree(Y = R1_AIMS2.f, A = SMPA, H = Cov, mus.reg = mus2.reg1_AIMS2.f, lambda.pct= 0.02, depth = 3, minsplit = max(0.05 * N, 16))
knitr::kable(tree1_AIMS2.f, digits = 2)
```


# 4. Analysis on the two cohort 

```{r}
# Calculate correlation 
cor.test(CompY1$MHQ_pain_enrollment, CompY1$AIMS2_enrollment)
cor.test(FullY1$MHQ_pain_enrollment, FullY1$AIMS2_enrollment)

cor.test(CompY1$GRIP_AVG, CompY1$SUM_MPEXTLAG_enrollment)
cor.test(FullY1$GRIP_AVG, FullY1$SUM_MPEXTLAG_enrollment)

cor.test(CompY1$GRIP_AVG, CompY1$SUM_MPUD_enrollment) # ***
cor.test(FullY1$GRIP_AVG, FullY1$SUM_MPUD_enrollment) # ***


CovWant = data.frame(GRIP_AVG = CompY1$GRIP_AVG, SUM_MPEXTLAG_enrollment = CompY1$SUM_MPEXTLAG_enrollment,SUM_MPUD_enrollment = CompY1$SUM_MPUD_enrollment)
chart.Correlation(CovWant, histogram=TRUE, pch=19)
chart.Correlation(CompY1, histogram=TRUE, pch=19)
chart.Correlation(FullY1, histogram=TRUE, pch=19) # *** Use this
```
